<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Calling Conventions :: New OSDev Wiki</title>
    <link rel="canonical" href="https://osdev.wiki/wiki/calling_conventions.html">
    <meta name="description" content="Examples of calling conventions on common platforms">
    <meta name="keywords" content="assembly, x86, x64, sysv, msvc">
    <meta name="generator" content="Antora 3.0.0-beta.5">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://osdev.wiki">New OSDev Wiki</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wiki" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">New OSDev Wiki</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">About This Wiki</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Introduction</span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="time_travel.html"><strong>Modern OS Development</strong></a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Requirements</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Licensing</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Compiler Setup</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Bare Bones / Baby Steps</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stivale_barebones.html">Stivale Barebones</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Stivale C# Barebones</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Design</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Consider Innovation</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kernel</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kernel Models</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Monolithic Kernel</span>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Microkernel</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Nanokernel</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Picokernel</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Exokernel</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Kernel Modularity</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Higher-half Kernel</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tasking and Scheduling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">What is a Task?</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Task vs. Process vs Thread</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Monotasking Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Multitasking Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Real-Time Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Context Switching</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Preemption</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Scheduling Algorithms</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Resource Sharing</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Memory and Resource Management</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Overview of Memory Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Paging</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Segmentation</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Memory Allocation</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Page Frame Allocation</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Memory Management Unit</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">File Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Network Resource Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Queuing Algorithms</span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hardware</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Firmware</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bios.html">BIOS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="uefi.html">UEFI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">ACPI</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architectures</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="x86.html">x86</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Processor Modes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="x86.html#_real_mode">Real Mode</a>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Unreal Mode</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Virtual 8086 Mode</span>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="x86.html#_protected_mode_32_bit">Protected Mode</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="long_mode.html">Long Mode</a>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">System Management Mode</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Interrupts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Interrupt Descriptor Table (IDT)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Interrupt Service Routines (ISR)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Advanced Programmable Interrupt Controller (APIC)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Timing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Time Stamp Counter</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">High Performance Event Timer (HPET)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">APIC Timer</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Programmable Interrupt Timer (PIT)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">CMOS and RTC</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Detecting CPU Speed</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="arm.html">ARM</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Busses</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Peripheral Component Interconnect (PCI)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">PCI Express (PCIe)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Universal Serial Bus (USB)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Extensible Host Controller Interface (XHCI)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Enhanced Host Controller Interface (EHCI)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Advanced Host Controller Interface (AHCI)</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">NVM Express (NVMe)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Storage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gpt.html">GUID Partition Table (GPT)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Master Boot Record (MBR)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Video</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text">VESA BIOS Extensions (VBE)</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">UEFI Graphics Output Protocol (GOP)</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Intel Graphics Technology</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tools</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Bootloaders</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Bootloader Theory</span>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Protocols</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="stivale.html">Stivale</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="multiboot.html">Multiboot</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Implementations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="limine.html">Limine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">GRUB</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Your Own Bootloader</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Compilers</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="calling_conventions.html">Calling Conventions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="clang.html">Clang</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="cross_clang.html">clang Cross-Compiler</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="visual_studio.html">Visual Studio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Assemblers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">LLVM (llvm-as)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">NASM</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">FASM</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">YASM</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">GAS (GNU as)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Linkers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">LLD (LLVM ld)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">LD (GNU ld)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Link Archiver (GNU ar)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Virtualization and Emulation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">QEMU</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">VirtualBox</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">VMWare</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Hyper-V</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">KVM</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Disk Image Manipulation</span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">New OSDev Wiki</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">New OSDev Wiki</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">New OSDev Wiki</a></li>
    <li>Tools</li>
    <li>Bootloaders</li>
    <li>Compilers</li>
    <li><a href="calling_conventions.html">Calling Conventions</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/osdev-wiki/wiki/edit/main/modules/ROOT/pages/calling_conventions.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Calling Conventions</h1>
<div class="sect1">
<h2 id="_what_are_calling_conventions"><a class="anchor" href="#_what_are_calling_conventions"></a>What are calling conventions?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A calling convention is the set of contracts that compiler-generated machine code respects and expects external functions to respect. The calling convention specifies, for example</p>
</div>
<div class="ulist">
<ul>
<li>
<p>how parameters are passed to functions</p>
</li>
<li>
<p>how the stack is handled and cleaned (for example if needs to be aligned at function entry)</p>
</li>
<li>
<p>how structures are going to be laid out in memory</p>
</li>
<li>
<p>which registers need to be restored by the caller and which by the callee</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_x86_64_calling_conventions"><a class="anchor" href="#_x86_64_calling_conventions"></a>x86-64 calling conventions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Windows (including UEFI) world and the UNIX (Linux, macOS, BSDs) world have adopted two different conventions. Note that MSVC can only generate code using the Windows calling convention.</p>
</div>
<div class="sect2">
<h3 id="_microsoft_x641"><a class="anchor" href="#_microsoft_x641"></a>Microsoft x64<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The x64 Application Binary Interface (ABI) uses a four-register fast-call calling convention by default. Space is allocated on the call stack as a shadow store for callees to save those registers.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>There&#8217;s a strict one-to-one correspondence between a function call&#8217;s arguments and the registers used for those arguments. Any argument that doesn&#8217;t fit in 8 bytes, or isn&#8217;t 1, 2, 4, or 8 bytes, must be passed by reference. A single argument is never spread across multiple registers.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The x87 register stack is unused. It may be used by the callee, but consider it volatile across function calls. All floating point operations are done using the 16 XMM registers.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Integer arguments are passed in registers RCX, RDX, R8, and R9. Floating point arguments are passed in XMM0L, XMM1L, XMM2L, and XMM3L. 16-byte arguments are passed by reference. Parameter passing is described in detail in Parameter passing. These registers, and RAX, R10, R11, XMM4, and XMM5, are considered volatile.</p>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="_register_allocation"><a class="anchor" href="#_register_allocation"></a>Register allocation</h4>
<div class="paragraph">
<p>Caller-saved: RAX, RCX, RDX,  R8, R9, R10, R11</p>
</div>
<div class="paragraph">
<p>Callee-saved: RBX, RBP, RDI, RSI, RSP, R12, R13, R14, R15</p>
</div>
</div>
<div class="sect3">
<h4 id="_stack"><a class="anchor" href="#_stack"></a>Stack</h4>
<div class="paragraph">
<p>The stack is always 16-byte aligned at function <strong>entry</strong>: this requires the stack to be <strong>NOT</strong> aligned to 16 bytes before the <code>CALL</code>, since the instruction pushes 8 bytes on the stack.</p>
</div>
<div class="paragraph">
<p>All functions need to have 32 bytes of home space (also known as spill space or shadow space), which is allocated <strong>before</strong> pushing the other parameters on the stack. This allows for an easier implementation of variadic functions: <code>va_start</code> can just put the four register parameters in the home space such that <code>va_arg</code> simply becomes a lookup starting at RSP.</p>
</div>
<div class="paragraph">
<p>For example, if the caller calls a function with 4 or 5 arguments, it needs to allocate 40 bytes of stack in order for the stack at the callee entry to be 48 bytes below the caller&#8217;s stack.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parameters"><a class="anchor" href="#_parameters"></a>Parameters</h4>
<div class="paragraph">
<p><code>RCX</code>/<code>XMM0</code>, <code>RDX</code>/<code>XMM1</code>, <code>R8</code>/<code>XMM2</code>, <code>R9</code>/<code>XMM3</code>, stack (<code>[RSP+0x20]</code>, <code>[RSP+0x28]</code> and so on, 0x20 is due to the home space being there).</p>
</div>
<div class="paragraph">
<p>For example, a function with the prototype</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c"> void DoSomething(int a, float b, int c, int d, int e, float f);</code></pre>
</div>
</div>
<div class="paragraph">
<p>would pass parameters in RCX, XMM1, R8, R9, [RSP+0x20] and [RSP+0x28] respectively. A function calling this needs to have at least 56 bytes of stack to store the parameters and home space and ensure that the stack is aligned after the <code>CALL</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_return_value"><a class="anchor" href="#_return_value"></a>Return value</h4>
<div class="paragraph">
<p>If the return value is an integer/struct/union whose size is less than or equal than 64 bits, it&#8217;s returned in RAX; otherwise, the struct is allocated by the caller and a pointer to it is passed as the first parameter.</p>
</div>
<div class="paragraph">
<p><code>LargeStruct DoSomething(int a)</code>
actually becomes
<code>void DoSomething(LargeStruct *ret, int a)</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_system_v2"><a class="anchor" href="#_system_v2"></a>System V<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The standard calling sequence requirements apply only to global functions. Local functions that are not reachable from other compilation units may use different conventions. Nevertheless, it is recommended that all functions use the standard calling sequence when possible.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The CPU shall be in x87 mode upon entry to a function. Therefore, every function that uses the MMX registers is required to issue an EMMS or FEMMS instruction after using MMX registers, before returning or calling another function.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The direction flag DF in the RFLAGS register must be clear (set to “forward” direction) on function entry and return. Other user flags have no specified role in the standard calling sequence and are not preserved across calls.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Registers RBP, RBX and
R12 through R15 “belong” to the calling function and the called function is required to preserve their values. In other words, a called function must preserve these registers’ values for its caller. Remaining registers “belong” to the called function.</p>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="_register_allocation_2"><a class="anchor" href="#_register_allocation_2"></a>Register allocation</h4>
<div class="paragraph">
<p>Caller-saved: RAX, RCX, RDX, RDI, RSI, R8, R9, R10, R11</p>
</div>
<div class="paragraph">
<p>Callee-saved: RBX, RBP, RSP R12, R13, R14, R15</p>
</div>
</div>
<div class="sect3">
<h4 id="_stack_2"><a class="anchor" href="#_stack_2"></a>Stack</h4>
<div class="paragraph">
<p>The stack is always 16-byte aligned at function <strong>call</strong>: this requires the stack to be aligned to 16 bytes before the <code>CALL</code>. The push of the return address onto the stack by <code>CALL</code> is immediately succeeded by the push of RBP onto the stack by the callee function, thereby re-aligning the stack shortly after function entry.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parameters_2"><a class="anchor" href="#_parameters_2"></a>Parameters</h4>
<div class="paragraph">
<p><code>RDI</code>, <code>RSI</code>, <code>RDX</code>, <code>RCX</code>, <code>R8</code>, <code>R9</code>, stack (<code>[RSP+0x00]</code>, <code>[RSP+0x08]</code> and so on).</p>
</div>
<div class="paragraph">
<p>If the parameter is of type <code>float</code> or <code>double</code>, it will be stored in the next available SSE register (<code>XMM0</code>-<code>XMM7</code>).</p>
</div>
<div class="paragraph">
<p>For example, a function with the prototype <code>void DoSomething(int a, float b, int c, int d, int e, float f)</code> would pass parameters in <code>RDI</code>, <code>XMM0</code>, <code>R8</code>, <code>R9</code>, <code>[RSP+0x00]</code> and <code>XMM1</code> respectively. A function calling this needs to have at least 32 bytes of stack to store the parameters and align the stack upon call.</p>
</div>
</div>
<div class="sect3">
<h4 id="_return_value_2"><a class="anchor" href="#_return_value_2"></a>Return value</h4>
<div class="paragraph">
<p>If the return value is an integer/struct/union whose size is less than or equal than 64 bits, it&#8217;s returned in <code>RAX</code>; otherwise, the struct is allocated by the caller and a pointer to it is passed as the first parameter, similarly to the Microsoft x64 ABI. Dissimilarly, the pointer is actually returned in <code>RAX</code> upon return.</p>
</div>
<div class="paragraph">
<p><code>LargeStruct DoSomething(int a)</code>
actually becomes
<code>LargeStruct* DoSomething(LargeStruct *ret, int a)</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_see_also"><a class="anchor" href="#_see_also"></a>See Also</h3>

</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://github.com/MicrosoftDocs/cpp-docs/blob/main/docs/build/x64-calling-convention.md" class="bare">https://github.com/MicrosoftDocs/cpp-docs/blob/main/docs/build/x64-calling-convention.md</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://raw.githubusercontent.com/wiki/hjl-tools/x86-psABI/x86-64-psABI-1.0.pdf" class="bare">https://raw.githubusercontent.com/wiki/hjl-tools/x86-psABI/x86-64-psABI-1.0.pdf</a>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
