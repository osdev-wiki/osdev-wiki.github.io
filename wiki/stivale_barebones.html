<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Stivale Barebones :: New OSDev Wiki</title>
    <link rel="canonical" href="https://osdev.wiki/wiki/stivale_barebones.html">
    <meta name="description" content="A tutorial on how to write a minimal kernel using a stivale2-compliant bootloader.">
    <meta name="keywords" content="tutorial, kernel, barebones">
    <meta name="generator" content="Antora 3.0.0-beta.5">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://osdev.wiki">New OSDev Wiki</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wiki" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">New OSDev Wiki</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">About This Wiki</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Introduction</span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="time_travel.html"><strong>Modern OS Development</strong></a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Requirements</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Licensing</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Compiler Setup</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Bare Bones / Baby Steps</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="stivale_barebones.html">Stivale Barebones</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Stivale C# Barebones</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Design</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Consider Innovation</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kernel</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kernel Models</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Monolithic Kernel</span>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Microkernel</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Nanokernel</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Picokernel</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Exokernel</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Kernel Modularity</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Higher-half Kernel</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tasking and Scheduling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">What is a Task?</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Task vs. Process vs Thread</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Monotasking Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Multitasking Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Real-Time Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Context Switching</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Preemption</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Scheduling Algorithms</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Resource Sharing</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Memory and Resource Management</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Overview of Memory Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Paging</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Segmentation</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Memory Allocation</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Page Frame Allocation</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Memory Management Unit</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">File Systems</span>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Network Resource Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Queuing Algorithms</span>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hardware</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Firmware</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bios.html">BIOS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="uefi.html">UEFI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">ACPI</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architectures</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="x86.html">x86</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Processor Modes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="x86.html#_real_mode">Real Mode</a>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Unreal Mode</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Virtual 8086 Mode</span>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="x86.html#_protected_mode_32_bit">Protected Mode</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="long_mode.html">Long Mode</a>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">System Management Mode</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Interrupts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Interrupt Descriptor Table (IDT)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Interrupt Service Routines (ISR)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Advanced Programmable Interrupt Controller (APIC)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Timing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Time Stamp Counter</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">High Performance Event Timer (HPET)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">APIC Timer</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Programmable Interrupt Timer (PIT)</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">CMOS and RTC</span>
  </li>
  <li class="nav-item" data-depth="4">
    <span class="nav-text">Detecting CPU Speed</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="arm.html">ARM</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Busses</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Peripheral Component Interconnect (PCI)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">PCI Express (PCIe)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Universal Serial Bus (USB)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Extensible Host Controller Interface (XHCI)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Enhanced Host Controller Interface (EHCI)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Advanced Host Controller Interface (AHCI)</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">NVM Express (NVMe)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Storage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gpt.html">GUID Partition Table (GPT)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Master Boot Record (MBR)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Video</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text">VESA BIOS Extensions (VBE)</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">UEFI Graphics Output Protocol (GOP)</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Intel Graphics Technology</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tools</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Bootloaders</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Bootloader Theory</span>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Protocols</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="stivale.html">Stivale</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="multiboot.html">Multiboot</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Implementations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="limine.html">Limine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">GRUB</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Your Own Bootloader</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Compilers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="calling_conventions.html">Calling Conventions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="clang.html">Clang</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="cross_clang.html">clang Cross-Compiler</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="visual_studio.html">Visual Studio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Assemblers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">LLVM (llvm-as)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">NASM</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">FASM</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">YASM</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">GAS (GNU as)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Linkers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">LLD (LLVM ld)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">LD (GNU ld)</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Link Archiver (GNU ar)</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Virtualization and Emulation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <span class="nav-text">QEMU</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">VirtualBox</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">VMWare</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">Hyper-V</span>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text">KVM</span>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Disk Image Manipulation</span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">New OSDev Wiki</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">New OSDev Wiki</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">New OSDev Wiki</a></li>
    <li>Tutorials</li>
    <li>Bare Bones / Baby Steps</li>
    <li><a href="stivale_barebones.html">Stivale Barebones</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/osdev-wiki/wiki/edit/main/modules/ROOT/pages/stivale_barebones.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Stivale Barebones</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_stivale"><a class="anchor" href="#_what_is_stivale"></a>What is stivale?</h3>
<div class="paragraph">
<p><strong>stivale</strong> means "boot" in Italian. It is a boot protocol designed to overcome shortcomings of common boot protocols used by hobbyist OS developers, such as <a href="multiboot.html" class="xref page">Multiboot</a>.</p>
</div>
<div class="paragraph">
<p>There are actually 2 revisions of the stivale boot protocol, namely: <strong>stivale</strong>, and <strong>stivale2</strong>. The earlier stivale revision (simply "stivale", but for clarity we are going to call it "stivale1" from now on), is a very simple <a href="https://en.wikipedia.org/wiki/KISS_principle">"KISS"</a> boot protocol only supporting what was deemed necessary at the time, but versioning and expandability issues made creating stivale2 a necessity. stivale2 makes use of tags for bootloader writers' and kernel writers' convenience, and to make future expandability and revisioning easier.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
stivale1 is deprecated and should be avoided for new kernels.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>stivale is firmware and architecture agnostic, though the only bootloader fully supporting the stivale protocols as of writing this article (2021/01/09) is <a href="limine.html" class="xref page">Limine</a>, which is an x86/x86_64 <a href="bios.html" class="xref page">BIOS</a> and <a href="uefi.html" class="xref page">UEFI</a> bootloader, with <a href="https://github.com/TomatOrg/TomatBoot">TomatBoot</a> (now archived) and <a href="https://github.com/FlorenceOS/Sabaton">Sabaton</a> offering limited stivale compliance for <a href="uefi.html#x86" class="xref page">x86_64 UEFI</a> exclusively, and <a href="arm.html#AArch64" class="xref page">aarch64</a>, respectively.</p>
</div>
<div class="paragraph">
<p>This article will demonstrate how to write a small 64-bit higher-half stivale2 kernel in (GNU) C, and boot it using the <a href="limine.html" class="xref page">Limine</a> bootloader.</p>
</div>
<div class="paragraph">
<p>It is also recommended to check out <a href="https://github.com/limine-bootloader/limine-barebones">this</a> project as it provides example buildable code to go along with this tutorial.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial"><a class="anchor" href="#_tutorial"></a>Tutorial</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_code"><a class="anchor" href="#_the_code"></a>The Code</h3>
<div class="paragraph">
<p>For this example, we will create these 2 files and place them in the same directory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>kernel.c</p>
</li>
<li>
<p>linker.ld</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As one may notice, there is no "entry point" assembly stub, as one is not necessary with either stivale1 or 2, when using a language which can make use of a standard System V x86 <a href="calling_conventions.html" class="xref page">calling convention</a>.</p>
</div>
<div class="paragraph">
<p>Furthermore, we will download the header file <code>stivale2.h</code> which defines structures that we will use to interact with the bootloader from <a href="https://raw.githubusercontent.com/stivale/stivale/master/stivale2.h">here</a>, and place it in the same directory as the other files.</p>
</div>
<div class="paragraph">
<p>Obviously, this is just a bare bones example, and one should always refer to the <a href="https://github.com/stivale/stivale/blob/master/STIVALE2.md">[stivale2 specification</a> for more details and information.</p>
</div>
<div class="paragraph">
<p>This is the kernel "main".</p>
</div>
<div class="listingblock">
<div class="title">kernel.c</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#include &lt;stdint.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stivale2.h&gt;

// We need to tell the stivale bootloader where we want our stack to be.
// We are going to allocate our stack as an array in .bss.
static uint8_t stack[8192];

// stivale2 uses a linked list of tags for both communicating TO the
// bootloader, or receiving info FROM it. More information about these tags
// is found in the stivale2 specification.

// stivale2 offers a runtime terminal service which can be ditched at any
// time, but it provides an easy way to print out to graphical terminal,
// especially during early boot.
// Read the notes about the requirements for using this feature below this
// code block.
static struct stivale2_header_tag_terminal terminal_hdr_tag = {
    // All tags need to begin with an identifier and a pointer to the next tag.
    .tag = {
        // Identification constant defined in stivale2.h and the specification.
        .identifier = STIVALE2_HEADER_TAG_TERMINAL_ID,
        // If next is 0, it marks the end of the linked list of header tags.
        .next = 0
    },
    // The terminal header tag possesses a flags field, leave it as 0 for now
    // as it is unused.
    .flags = 0
};

// We are now going to define a framebuffer header tag.
// This tag tells the bootloader that we want a graphical framebuffer instead
// of a CGA-compatible text mode. Omitting this tag will make the bootloader
// default to text mode, if available.
static struct stivale2_header_tag_framebuffer framebuffer_hdr_tag = {
    // Same as above.
    .tag = {
        .identifier = STIVALE2_HEADER_TAG_FRAMEBUFFER_ID,
        // Instead of 0, we now point to the previous header tag. The order in
        // which header tags are linked does not matter.
        .next = (uint64_t)&amp;terminal_hdr_tag
    },
    // We set all the framebuffer specifics to 0 as we want the bootloader
    // to pick the best it can.
    .framebuffer_width  = 0,
    .framebuffer_height = 0,
    .framebuffer_bpp    = 0
};

// The stivale2 specification says we need to define a "header structure".
// This structure needs to reside in the .stivale2hdr ELF section in order
// for the bootloader to find it. We use this __attribute__ directive to
// tell the compiler to put the following structure in said section.
__attribute__((section(".stivale2hdr"), used))
static struct stivale2_header stivale_hdr = {
    // The entry_point member is used to specify an alternative entry
    // point that the bootloader should jump to instead of the executable's
    // ELF entry point. We do not care about that so we leave it zeroed.
    .entry_point = 0,
    // Let's tell the bootloader where our stack is.
    // We need to add the sizeof(stack) since in x86(_64) the stack grows
    // downwards.
    .stack = (uintptr_t)stack + sizeof(stack),
    // Bit 1, if set, causes the bootloader to return to us pointers in the
    // higher half, which we likely want since this is a higher half kernel.
    // Bit 2, if set, tells the bootloader to enable protected memory ranges,
    // that is, to respect the ELF PHDR mandated permissions for the executable's
    // segments.
    // Bit 3, if set, enables fully virtual kernel mappings, which we want as
    // they allow the bootloader to pick whichever *physical* memory address is
    // available to load the kernel, rather than relying on us telling it where
    // to load it.
    // Bit 4 disables a deprecated feature and should always be set.
    .flags = (1 &lt;&lt; 1) | (1 &lt;&lt; 2) | (1 &lt;&lt; 3) | (1 &lt;&lt; 4),
    // This header structure is the root of the linked list of header tags and
    // points to the first one in the linked list.
    .tags = (uintptr_t)&amp;framebuffer_hdr_tag
};

// We will now write a helper function which will allow us to scan for tags
// that we want FROM the bootloader (structure tags).
void *stivale2_get_tag(struct stivale2_struct *stivale2_struct, uint64_t id) {
    struct stivale2_tag *current_tag = (void *)stivale2_struct-&gt;tags;
    for (;;) {
        // If the tag pointer is NULL (end of linked list), we did not find
        // the tag. Return NULL to signal this.
        if (current_tag == NULL) {
            return NULL;
        }

        // Check whether the identifier matches. If it does, return a pointer
        // to the matching tag.
        if (current_tag-&gt;identifier == id) {
            return current_tag;
        }

        // Get a pointer to the next tag in the linked list and repeat.
        current_tag = (void *)current_tag-&gt;next;
    }
}

// The following will be our kernel's entry point.
void _start(struct stivale2_struct *stivale2_struct) {
    // Let's get the terminal structure tag from the bootloader.
    struct stivale2_struct_tag_terminal *term_str_tag;
    term_str_tag = stivale2_get_tag(stivale2_struct, STIVALE2_STRUCT_TAG_TERMINAL_ID);

    // Check if the tag was actually found.
    if (term_str_tag == NULL) {
        // It wasn't found, just hang...
        for (;;) {
            asm ("hlt");
        }
    }

    // Let's get the address of the terminal write function.
    void *term_write_ptr = (void *)term_str_tag-&gt;term_write;

    // Now, let's assign this pointer to a function pointer which
    // matches the prototype described in the stivale2 specification for
    // the stivale2_term_write function.
    void (*term_write)(const char *string, size_t length) = term_write_ptr;

    // We should now be able to call the above function pointer to print out
    // a simple "Hello World" to screen.
    term_write("Hello World", 11);

    // We're done, just hang...
    for (;;) {
        asm ("hlt");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using the stivale2 terminal requires that the kernel maintains some state as described in the <a href="https://github.com/stivale/stivale/blob/master/STIVALE2.md\#x86\_64-1">specification</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is going to be our linker script describing where our sections will end up in memory.</p>
</div>
<div class="listingblock">
<div class="title">linker.ld</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">/* Tell the linker that we want an x86_64 ELF64 output file */
OUTPUT_FORMAT(elf64-x86-64)
OUTPUT_ARCH(i386:x86-64)

/* We want the symbol _start to be our entry point */
ENTRY(_start)

/* Define the program headers we want so the bootloader gives us the right */
/* MMU permissions */
PHDRS
{
    null    PT_NULL    FLAGS(0) ;                   /* Null segment */
    text    PT_LOAD    FLAGS((1 &lt;&lt; 0) | (1 &lt;&lt; 2)) ; /* Execute + Read */
    rodata  PT_LOAD    FLAGS((1 &lt;&lt; 2)) ;            /* Read only */
    data    PT_LOAD    FLAGS((1 &lt;&lt; 1) | (1 &lt;&lt; 2)) ; /* Write + Read */
}

SECTIONS
{
    /* We wanna be placed in the topmost 2GiB of the address space, for optimisations */
    /* and because that is what the stivale2 spec mandates. */
    /* Any address in this region will do, but often 0xffffffff80000000 is chosen as */
    /* that is the beginning of the region. */
    . = 0xffffffff80000000;

    .text : {
        *(.text*)
    } :text

    /* Move to the next memory page for .rodata */
    . += CONSTANT(MAXPAGESIZE);

    /* We place the .stivale2hdr section containing the header in its own section, */
    /* and we use the KEEP directive on it to make sure it doesn't get discarded. */
    .stivale2hdr : {
        KEEP(*(.stivale2hdr))
    } :rodata

    .rodata : {
        *(.rodata*)
    } :rodata

    /* Move to the next memory page for .data */
    . += CONSTANT(MAXPAGESIZE);

    .data : {
        *(.data*)
    } :data

    .bss : {
        *(COMMON)
        *(.bss*)
    } :data
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_the_kernel_and_creating_an_image"><a class="anchor" href="#_building_the_kernel_and_creating_an_image"></a>Building the kernel and creating an image</h3>
<div class="sect3">
<h4 id="_makefile"><a class="anchor" href="#_makefile"></a>Makefile</h4>
<div class="paragraph">
<p>In order to build our kernel, we are going to use a Makefile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-makefile hljs" data-lang="makefile"># This is the name that our final kernel executable will have.
# Change as needed.
KERNEL := myos.elf

# It is highly recommended to use a custom built cross toolchain to build a kernel.
# We are only using "cc" as a placeholder here. It may work by using
# the host system's toolchain, but this is not guaranteed.
CC ?= cc

# Likewise, "ld" here is just a placeholder and your mileage may vary if using the
# host's "ld".
LD ?= ld

# User controllable CFLAGS.
CFLAGS ?= -Wall -Wextra -O2 -pipe

# User controllable linker flags. We set none by default.
LDFLAGS ?=

# Internal C flags that should not be changed by the user.
INTERNALCFLAGS :=            \
    -I.                  \
    -std=gnu11           \
    -ffreestanding       \
    -fno-stack-protector \
    -fno-pic             \
    -mno-80387           \
    -mno-mmx             \
    -mno-3dnow           \
    -mno-sse             \
    -mno-sse2            \
    -mno-red-zone        \
        -mcmodel=kernel      \
        -MMD

# Internal linker flags that should not be changed by the user.
INTERNALLDFLAGS :=             \
    -Tlinker.ld            \
    -nostdlib              \
    -zmax-page-size=0x1000 \
    -static

# Use find to glob all *.c files in the directory and extract the object names.
CFILES := $(shell find ./ -type f -name '*.c')
OBJ := $(CFILES:.c=.o)
HEADER_DEPS := $(CFILES:.c=.d)

# Default target.
.PHONY: all
all: $(KERNEL)

# Link rules for the final kernel executable.
$(KERNEL): $(OBJ)
    $(LD) $(OBJ) $(LDFLAGS) $(INTERNALLDFLAGS) -o $@

# Compilation rules for *.c files.
-include $(HEADER_DEPS)
%.o: %.c
    $(CC) $(CFLAGS) $(INTERNALCFLAGS) -c $&lt; -o $@

# Remove object files and the final executable.
.PHONY: clean
clean:
    rm -rf $(KERNEL) $(OBJ) $(HEADER_DEPS)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_limine_cfg"><a class="anchor" href="#_limine_cfg"></a>limine.cfg</h4>
<div class="paragraph">
<p>This file is parsed by Limine and it describes boot entries and other bootloader configuration variables. Further information <a href="https://github.com/limine-bootloader/limine/blob/trunk/CONFIG.md">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini"># Timeout in seconds that Limine will use before automatically booting.
TIMEOUT=5

# The entry name that will be displayed in the boot menu
:myOS

# Change the protocol line depending on the used protocol.
PROTOCOL=stivale2

# Path to the kernel to boot. boot:/// represents the partition on which limine.cfg is located.
KERNEL_PATH=boot:///myos.elf</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compiling_the_kernel"><a class="anchor" href="#_compiling_the_kernel"></a>Compiling the kernel</h4>
<div class="paragraph">
<p>We can now build our example kernel by running <strong>make</strong>. This command, if successful, should generate a file called <code>myos.elf</code> (or the chosen kernel name). This is our stivale2-compliant kernel executable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_image"><a class="anchor" href="#_creating_the_image"></a>Creating the image</h4>
<div class="paragraph">
<p>We can now create either an ISO or a hard disk/USB drive image with our kernel on it. <a href="limine.html" class="xref page">Limine</a> can boot on both <a href="bios.html" class="xref page">BIOS</a> and <a href="uefi.html" class="xref page">UEFI</a> if the image is set up to do so, which is what we are going to do.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_an_iso"><a class="anchor" href="#_creating_an_iso"></a>Creating an ISO</h3>
<div class="paragraph">
<p>In this example we are going to create a CD-ROM ISO capable of booting on both <a href="uefi.html" class="xref page">UEFI</a> and legacy <a href="bios.html" class="xref page">BIOS</a> systems.</p>
</div>
<div class="paragraph">
<p>For this to work, we will need the <strong>xorriso</strong> utility.</p>
</div>
<div class="paragraph">
<p>These are shell commands. They can also be compiled into a script or Makefile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># Download the latest Limine binary release.
git clone https://github.com/limine-bootloader/limine.git --branch=v2.0-branch-binary --depth=1

# Build limine-install.
make -C limine

# Create a directory which will be our ISO root.
mkdir -p iso_root

# Copy the relevant files over.
cp -v myos.elf limine.cfg limine/limine.sys \
      limine/limine-cd.bin limine/limine-eltorito-efi.bin iso_root/

# Create the bootable ISO.
xorriso -as mkisofs -b limine-cd.bin \
        -no-emul-boot -boot-load-size 4 -boot-info-table \
        --efi-boot limine-eltorito-efi.bin \
        -efi-boot-part --efi-boot-image --protective-msdos-label \
        iso_root -o image.iso

# Install Limine stage 1 and 2 for legacy BIOS boot.
./limine/limine-install image.iso</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_hard_diskusb_drive_image"><a class="anchor" href="#_creating_a_hard_diskusb_drive_image"></a>Creating a hard disk/USB drive image</h3>
<div class="paragraph">
<p>In this example we&#8217;ll create a <a href="gpt.html" class="xref page">GPT</a> partition table using <strong>parted</strong>, containing a single FAT partition, also known as the <a href="uefi.html#ESP" class="xref page">ESP</a> in EFI terminology, which will store our kernel, configs, and bootloader.</p>
</div>
<div class="paragraph">
<p>This example is more involved and is made up of more steps than creating an ISO image.</p>
</div>
<div class="paragraph">
<p>These are shell commands. They can also be compiled into a script or Makefile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># Create an empty zeroed out 64MiB image file.
dd if=/dev/zero bs=1M count=0 seek=64 of=image.hdd

# Create a GPT partition table.
parted -s image.hdd mklabel gpt

# Create an ESP partition that spans the whole disk.
parted -s image.hdd mkpart ESP fat32 2048s 100%
parted -s image.hdd set 1 esp on

# Download the latest Limine binary release.
git clone https://github.com/limine-bootloader/limine.git --branch=v2.0-branch-binary --depth=1

# Build limine-install.
make -C limine

# Install the Limine BIOS stages onto the image.
./limine/limine-install image.hdd

# Mount the loopback device.
USED_LOOPBACK=$(sudo losetup -Pf --show image.hdd)

# Format the ESP partition as FAT32.
sudo mkfs.fat -F 32 ${USED_LOOPBACK}p1

# Mount the partition itself.
mkdir -p img_mount
sudo mount ${USED_LOOPBACK}p1 img_mount

# Copy the relevant files over.
sudo mkdir -p img_mount/EFI/BOOT
sudo cp -v myos.elf limine.cfg limine/limine.sys img_mount/
sudo cp -v limine/BOOTX64.EFI img_mount/EFI/BOOT/

# Sync system cache and unmount partition and loopback device.
sync
sudo umount img_mount
sudo losetup -d ${USED_LOOPBACK}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If everything above has been completed successfully, you should now have a bootable ISO or hard drive/USB image containing your 64-bit higher half stivale2 kernel and Limine to boot it. Once the kernel is successfully booted, you should see "Hello World" printed on screen.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see_also"><a class="anchor" href="#_see_also"></a>See Also</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/stivale/stivale/blob/master/STIVALE2.md">stivale2 specification</a></p>
</li>
<li>
<p><a href="https://github.com/FlorenceOS/Sabaton">The sabaton aarch64 stivale2 bootloader</a></p>
</li>
<li>
<p><a href="https://github.com/TomatOrg/TomatBoot">The TomatBoot x86\_64 UEFI stivale1 and 2 bootloader</a> (now archived)</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
